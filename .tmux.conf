# =====================================
# ===         General               ===
# =====================================
# TrueColor
set-option -ga terminal-overrides "xterm-256color"
set-window-option -g xterm-keys on
setw -g mode-keys vi
set -g mouse on
set -s escape-time 0
set -s focus-events on

# cmd+c and drag/drop support
set -g default-command "reattach-to-user-namespace -l /usr/local/bin/fish"

# iterm tab name
set -g set-titles on
setw -g set-titles-string "#S"

# for conditional binding
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# =====================================
# ===          Plugins              ===
# =====================================
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins/'
# tmux autostart and saving sessions between reebots
set -g @continuum-boot 'on'
set -g @continuum-restore 'on'
set -g @continuum-boot-options 'iterm'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-strategy-vim 'session'

# Status Line
set -g @themepack 'mytheme'
set -g @tmp-clean 'u'

# List of plugins
set -g @tpm_plugins '               \
   tmux-plugins/tpm                 \
   jimeh/tmux-themepack             \
   tmux-plugins/tmux-continuum      \
   tmux-plugins/tmux-copy           \
   tmux-plugins/tmux-resurrect      \
   tmux-plugins/tmux-sensible       \
   tmux-plugins/tmux-sessionist     \
   tmux-plugins/tmux-yank           \
   christoomey/vim-tmux-navigator   \
   NHDaly/tmux-scroll-copy-mode     \
'

run '~/.config/tmux/plugins/tpm/tpm'
# =====================================
# ===           Theme               ===
# =====================================

# named colors, just for convenience
color_orange="colour166" # 208, 166
color_purple="colour134" # 135, 134
color_green="colour076" # 070
color_blue="colour39"
color_yellow="colour220"
color_red="colour160"
color_black="colour232"
color_white="white" # 015

# color settings
color_dark="$color_black"
color_light="$color_white"
color_session_text="$color_blue"
color_status_text="colour245"
color_main="$color_orange"
color_secondary="$color_purple"
color_level_ok="$color_green"
color_level_warn="$color_yellow"
color_level_stress="$color_red"
color_window_off_indicator="colour088"
color_window_off_status_bg="colour238"
color_window_off_status_current_bg="colour254"

# =====================================
# ===         Controls              ===
# =====================================

# unbind non wanted commands
unbind '"'
unbind %
unbind C-b
unbind p
unbind n
unbind 0
unbind 1
unbind 2
unbind 3
unbind 4
unbind 5
unbind 6
unbind 7
unbind 8
unbind 9
unbind S
unbind C-z
unbind z
unbind =

# remap prefix to Control + a
set -g prefix C-a
bind C-a send-prefix

bind Escape copy-mode

# console
bind C-l send-keys 'C-l'

# windows
bind -n M-Q select-pane -t :.-
bind -n M-W select-pane -t :.+
bind -n M-q if-shell "$is_vim" "send-keys C-w w" "select-pane -t:.-"
bind -n M-w if-shell "$is_vim" "send-keys C-w W" "select-pane -t:.+"
bind -n F1 next-window      # BTT: C-Tab
bind -n F2 previous-window  # BTT: C-S-Tab

# joining panes
bind h command-prompt -p "join pane from:"  "join-pane -v -s '%%'"	# join target pane vertically
bind j command-prompt -p "join pane from:"  "join-pane -h -s '%%'"	# join target pane horizontally
bind d command-prompt -p "detach pane as:"  "break-pane -n '%%'"	# spits joined panes

# resizing panels
bind z if-shell "$is_vim" "send-keys C-w z" "resize-pane -Z"
bind Z resize-pane -Z
bind -n  C-S-Up resize-pane -U 5
bind -n  C-S-Down resize-pane -D 5
bind -n  C-S-Left resize-pane -L 5
bind -n  C-S-Right resize-pane -R 5

# split-window & split layouts
bind S split-window -h -c "#{pane_current_path}"
bind V split-window -v -c "#{pane_current_path}"
bind s if-shell "$is_vim" "send-keys C-w s" "split-window -h -c '#{pane_current_path}'"
bind v if-shell "$is_vim" "send-keys C-w v" "split-window -v -c '#{pane_current_path}'"
bind \\ select-layout even-vertical
bind | select-layout even-horizontal


# swap-windows (tabs) BTT: C-</>
bind -n F8 if-shell "$is_vim" "send-keys C-w <"
bind -n F9 if-shell "$is_vim" "send-keys C-w >"
bind -n F10 { swap-window -t -1; select-window -t -1 }
bind -n F11 { swap-window -t +1; select-window -t +1 }

bind x if-shell "$is_vim" "send-keys :qa! Enter" "confirm-before -p 'kill-pane #P? (y/n)' kill-pane"

# F12 toggle for nested tmux sessions
bind -T root F12  \
  set prefix None \;\
  set key-table off \;\
  set status-style "fg=$color_status_text,bg=$color_window_off_status_bg" \;\
  set window-status-current-format "#[fg=$color_window_off_status_bg,bg=$color_window_off_status_current_bg]#[default]#I \uE0B5 #W \uE0B5 #F #[bg=#3c3836,fg=$color_window_off_status_bg]\uE0B4" \;\
  set window-status-current-style "fg=$color_dark,bold,bg=$color_window_off_status_current_bg" \;\
  if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
  refresh-client -S \;\

bind -T off F12 \
  set -u prefix \;\
  set -u key-table \;\
  set -u status-style \;\
  set -u window-status-current-style \;\
  set -u window-status-current-format \;\
  refresh-client -S

bind J split-window -v "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"

bind C-j run-shell -b "tmux ls | sed 's/:.*$//' | grep -v \"^#{client_session}\$\" | fzf-tmux -p20%,15% --bind=\"enter:execute(tmux switch-client -t {1})+accept\""
